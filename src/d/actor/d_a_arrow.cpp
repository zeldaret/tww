//
// Generated by dtk
// Translation Unit: d_a_arrow.cpp
//

#include "d/actor/d_a_arrow.h"
#include "JSystem/JKernel/JKRHeap.h"
#include "m_Do/m_Do_mtx.h"
#include "d/d_com_inf_game.h"
#include "d/d_procname.h"
#include "d/d_npc.h"
#include "d/actor/d_a_player.h"
#include "d/d_jnt_hit.h"
#include "dolphin/types.h"

const char daArrow_c::m_arc_name[] = "Link";

/* 800D455C-800D457C       .text createHeap_CB__FP10fopAc_ac_c */
static BOOL createHeap_CB(fopAc_ac_c* i_this) {
    return ((daArrow_c*)i_this)->_createHeap();
}

/* 800D457C-800D4648       .text _createHeap__9daArrow_cFv */
BOOL daArrow_c::_createHeap() {
    // arrowglitter.bdl for Light Arrows, arrow.bdl otherwise.
    s32 modelFileIndex = (mArrowType == LIGHT_ARROWS ? 0x38 : 0x37) & 0xFFFF;
    J3DModelData* modelData = (J3DModelData*)dComIfG_getObjectRes(m_arc_name, modelFileIndex);
    JUT_ASSERT(190, modelData != 0);
    
    mpModel = mDoExt_J3DModel__create(modelData, 0x00080000, 0x11000022);
    if (!mpModel) {
        return FALSE;
    }
    return TRUE;
}

/* 800D4648-800D4668       .text atHit_CB__FP10fopAc_ac_cP12dCcD_GObjInfP10fopAc_ac_cP12dCcD_GObjInf */
void atHit_CB(fopAc_ac_c* i_this, dCcD_GObjInf* thisObjInf, fopAc_ac_c* hitActor, dCcD_GObjInf* hitObjInf) {
    ((daArrow_c*)i_this)->_atHit(thisObjInf, hitActor, hitObjInf);
}

/* 800D4668-800D47C0       .text _atHit__9daArrow_cFP12dCcD_GObjInfP10fopAc_ac_cP12dCcD_GObjInf */
void daArrow_c::_atHit(dCcD_GObjInf* thisObjInf, fopAc_ac_c* hitActor, dCcD_GObjInf* hitObjInf) {
    // Keep track of which actor this arrow hit as well as the position the hit occurred at.
    if (!hitActor) {
        return;
    }
    if (!fopAc_IsActor(hitActor)) {
        return;
    }
    if (!fopAcM_GetJntHit(hitActor)) {
        return;
    }
    
    cXyz hitPos(*thisObjInf->GetAtHitPosP());
    f32 hitDist = (hitPos - current.pos).abs();
    if (hitDist < mNearestHitDist) {
        mNearestHitDist = hitDist;
        mHitActorProcID = fpcM_GetID(hitActor);
        if (hitObjInf->ChkTgShield()) {
            mbHitActor = false;
            field_0x6ec = NULL;
        } else {
            mbHitActor = true;
            field_0x6ec = hitActor;
        }
        mNearestHitPos = *thisObjInf->GetAtHitPosP();
    }
}

/* 800D47C0-800D4814       .text checkCreater__9daArrow_cFv */
void daArrow_c::checkCreater() {
    // Check if this arrow was fired by Princess Zelda (during the Ganondorf fight).
    fopAc_ac_c* archer;
    if (fopAcM_SearchByID(mParentPcId, &archer)) {
        if (fpcM_GetName(archer) == PROC_PZ) {
            mbShotByZelda = true;
        }
    }
}

/* 800D4814-800D48E8       .text setLightEffect__9daArrow_cFv */
void daArrow_c::setLightEffect() {
    if (field_0x682 == mArrowType) {
        if (mArrowType == NORMAL_ARROWS) {
            return;
        }
        if (!field_0x688) {
            field_0x684 = fopAcM_createChild(
                PROC_ARROW_LIGHTEFF, fpcM_GetID(this),
                mArrowType, &field_0x6a8,
                current.roomNo, &shape_angle, NULL, -1, NULL
            );
            if (field_0x684 != -1) {
                field_0x688 = true;
            }
        }
    } else {
        fopAcM_delete(fopAcM_SearchByID(field_0x684));
        field_0x688 = false;
    }
    field_0x682 = mArrowType;
}

/* 800D48E8-800D4994       .text setBlur__9daArrow_cFv */
void daArrow_c::setBlur() {
    JPABaseEmitter* emitter = mPtclFollowCb.getEmitter();
    if (!emitter) {
        return;
    }
    s32 alpha = emitter->getGlobalAlpha();
    if (alpha - 50 <= 0) {
        mPtclFollowCb.end();
    } else {
        emitter->setGlobalAlpha(alpha - 50);
    }
    
    mDoMtx_stack_c::transS(current.pos);
    mDoMtx_stack_c::ZXYrotM(field_0x67c);
    emitter->setGlobalRTMatrix(mDoMtx_stack_c::get());
}

/* 800D4994-800D4A04       .text createBlur__9daArrow_cFv */
void daArrow_c::createBlur() {
    if (!mPtclFollowCb.getEmitter()) {
        dComIfGp_particle_setToon(0x48, &current.pos, NULL, NULL, 0xFF, &mPtclFollowCb, -1, NULL, NULL, NULL);
    }
}

/* 800D4A04-800D4ADC       .text setArrowShootSe__9daArrow_cFv */
void daArrow_c::setArrowShootSe() {
    /* Nonmatching */
}

/* 800D4ADC-800D4B70       .text setDrawShapeMaterial__9daArrow_cFv */
void daArrow_c::setDrawShapeMaterial() {
    /* Nonmatching */
}

/* 800D4B70-800D4D98       .text arrowShooting__9daArrow_cFv */
void daArrow_c::arrowShooting() {
    /* Nonmatching */
}

/* 800D4D98-800D4DC0       .text arrowUseMp__9daArrow_cFv */
void daArrow_c::arrowUseMp() {
    static const s16 use_mp[4] = {
        -0, // Normal Arrows
        -1, // Fire Arrows
        -1, // Ice Arrows
        -2, // Light Arrows
    };
    
    s32 magic = dComIfGp_getItemMagicCount();
    dComIfGp_setItemMagicCount(magic + use_mp[mArrowType]);
}

/* 800D4DC0-800D50A0       .text ShieldReflect__9daArrow_cFv */
void daArrow_c::ShieldReflect() {
    /* Nonmatching */
}

/* 800D50A0-800D5388       .text check_water_in__9daArrow_cFv */
void daArrow_c::check_water_in() {
    /* Nonmatching */
}

/* 800D5388-800D53AC       .text changeArrowMp__9daArrow_cFv */
BOOL daArrow_c::changeArrowMp() {
    u8 magic = dComIfGs_getMagic();
    return magic >= 1;
}

/* 800D53AC-800D553C       .text changeArrowType__9daArrow_cFv */
void daArrow_c::changeArrowType() {
    /* Nonmatching */
}

/* 800D553C-800D560C       .text changeArrowTypeNotReady__9daArrow_cFv */
void daArrow_c::changeArrowTypeNotReady() {
    /* Nonmatching */
}

/* 800D560C-800D56B0       .text setRoomInfo__9daArrow_cFv */
void daArrow_c::setRoomInfo() {
    u32 roomNo;
    
    mGndChk.SetPos(&current.pos);
    f32 groundY = dComIfG_Bgsp()->GroundCross(&mGndChk);
    if (groundY != -1000000000.0f) {
        roomNo = dComIfG_Bgsp()->GetRoomId(mGndChk);
        mTevStr.mEnvrIdxOverride = dComIfG_Bgsp()->GetPolyColor(mGndChk);
    } else {
        roomNo = dComIfGp_roomControl_getStayNo();
    }
    
    mTevStr.mRoomNo = roomNo;
    mStts.SetRoomId(roomNo);
    current.roomNo = roomNo;
}

/* 800D56B0-800D5854       .text setKeepMatrix__9daArrow_cFv */
void daArrow_c::setKeepMatrix() {
    /* Nonmatching */
    // Transform the arrow onto its archer's hand.
    if (mbShotByZelda) {
        fopNpc_npc_c* zelda;
        fopAcM_SearchByID(mParentPcId, (fopAc_ac_c**)&zelda);
        
        mDoMtx_stack_c::transS(0.7f, -0.07f, -0.2f);
        mDoMtx_stack_c::XYZrotM(0x238E, 0x2CDF, 0x29BE);
        
        // Copy the matrix of Zelda's hand_R1 joint to the arrow model.
        // TODO: After daPz_c is implemented, this should use her daPz_c::getRightHandMatrix() inline method.
        MtxP handMtx = zelda->mpMcaMorf->getModel()->mpNodeMtx[0x13];
        cMtx_concat(handMtx, mDoMtx_stack_c::get(), mDoMtx_stack_c::get());
        mpModel->setBaseTRMtx(mDoMtx_stack_c::get());
        
        MtxP mtx = mDoMtx_stack_c::get();
        current.pos.set(mtx[0][3], mtx[1][3], mtx[2][3]);
        
        mDoMtx_MtxToRot(mDoMtx_stack_c::get(), &shape_angle);
        current.angle.y = shape_angle.y;
        current.angle.x = -shape_angle.x;
    } else {
        daPy_py_c* player = daPy_getPlayerActorClass();
        
        mDoMtx_stack_c::transS(0.7f, -0.07f, -0.2f);
        // This function takes three signed shorts, but one of the literals passed here is unsigned.
        // X rotation must be a float literal to force the compiler to pass an unsigned short.
        // Z rotation must be an int literal to pass a signed short as normal.
        mDoMtx_stack_c::XYZrotM((248.5f*65536)/360, 0x238E, -0x6333);
        
        MtxP handMtx = player->getLeftHandMatrix();
        cMtx_concat(handMtx, mDoMtx_stack_c::get(), mDoMtx_stack_c::get());
        mpModel->setBaseTRMtx(mDoMtx_stack_c::get());
        
        MtxP mtx = mDoMtx_stack_c::get();
        current.pos.set(mtx[0][3], mtx[1][3], mtx[2][3]);
        
        mDoMtx_MtxToRot(mDoMtx_stack_c::get(), &shape_angle);
        current.angle.y = shape_angle.y;
        current.angle.x = -shape_angle.x;
    }
}

/* 800D5854-800D5A70       .text setStopActorMatrix__9daArrow_cFv */
void daArrow_c::setStopActorMatrix() {
    s16 xRot = 0;
    if (cLib_calcTimer(&field_0x604) != 0) {
        f32 temp = (field_0x604 / 40.0f);
        xRot = 1024.0f * temp*temp * cM_ssin(field_0x604 * 0x52FB);
    }
    fopAc_ac_c* hitActor = fopAcM_SearchByID(mHitActorProcID);
    if (!hitActor) {
        return;
    }
    JntHit_c* jntHit = fopAcM_GetJntHit(hitActor);
    if (!jntHit) {
        return;
    }
    J3DModel* hitModel = jntHit->getModel();
    
    static cXyz offset_arrow_pos(0.0f, 0.0f, -50.0f);
    
    mDoMtx_stack_c::copy(hitModel->mpNodeMtx[mHitJointIndex]);
    csXyz hitJointRot;
    mDoMtx_MtxToRot(mDoMtx_stack_c::get(), &hitJointRot);
    
    mDoMtx_stack_c::transM(field_0x618);
    mDoMtx_stack_c::ZXYrotM(field_0x6e6);
    
    cXyz pos(0.0f, 0.0f, 0.0f);
    mDoMtx_stack_c::multVecZero(&pos);
    current.pos = pos;
    
    mDoMtx_stack_c::transS(current.pos);
    mDoMtx_stack_c::ZXYrotM(hitJointRot);
    mDoMtx_stack_c::ZXYrotM(field_0x6e6);
    mDoMtx_stack_c::XrotM(xRot);
    mDoMtx_stack_c::transM(offset_arrow_pos);
    mpModel->setBaseTRMtx(mDoMtx_stack_c::get());
}

/* 800D5A70-800D5B20       .text procWait__9daArrow_cFv */
void daArrow_c::procWait() {
    /* Nonmatching */
}

/* 800D5B20-800D6BF4       .text procMove__9daArrow_cFv */
void daArrow_c::procMove() {
    /* Nonmatching */
}

/* 800D6BF4-800D6E70       .text procReturn__9daArrow_cFv */
void daArrow_c::procReturn() {
    /* Nonmatching */
}

/* 800D6E70-800D71F8       .text procStop_BG__9daArrow_cFv */
void daArrow_c::procStop_BG() {
    /* Nonmatching */
}

/* 800D71F8-800D727C       .text procStop_Actor__9daArrow_cFv */
void daArrow_c::procStop_Actor() {
    /* Nonmatching */
}

/* 800D727C-800D72BC       .text procWater__9daArrow_cFv */
void daArrow_c::procWater() {
    /* Nonmatching */
}

/* 800D72BC-800D72EC       .text checkRestMp__9daArrow_cFv */
void daArrow_c::checkRestMp() {
    static const s16 use_mp[4] = {
        0, // Normal Arrows
        1, // Fire Arrows
        1, // Ice Arrows
        2, // Light Arrows
    };
    
    u8 currMagic = dComIfGs_getMagic();
    if (currMagic < use_mp[m_keep_type]) {
        m_keep_type = 0;
    }
}

/* 800D72EC-800D7320       .text setTypeByPlayer__9daArrow_cFv */
void daArrow_c::setTypeByPlayer() {
    checkRestMp();
    mArrowType = m_keep_type;
}

/* 800D7320-800D74FC       .text createInit__9daArrow_cFv */
void daArrow_c::createInit() {
    /* Nonmatching */
}

/* 800D74FC-800D7820       .text _execute__9daArrow_cFv */
BOOL daArrow_c::_execute() {
    /* Nonmatching */
}

/* 800D7820-800D7960       .text _draw__9daArrow_cFv */
BOOL daArrow_c::_draw() {
    /* Nonmatching */
}

/* 800D7960-800D7A38       .text _create__9daArrow_cFv */
s32 daArrow_c::_create() {
    /* Nonmatching */
}

/* 800D7A38-800D7DB4       .text __ct__9daArrow_cFv */
daArrow_c::daArrow_c() : mPtclFollowCb(0, 0) {}

/* 800D81D0-800D8200       .text _delete__9daArrow_cFv */
BOOL daArrow_c::_delete() {
    mPtclFollowCb.end();
    return TRUE;
}

/* 800D8200-800D8220       .text daArrowCreate__FPv */
s32 daArrowCreate(void* i_this) {
    /* Nonmatching */
    return ((daArrow_c*)i_this)->_create();
}

/* 800D8220-800D8240       .text daArrowDelete__FPv */
BOOL daArrowDelete(void* i_this) {
    /* Nonmatching */
    return ((daArrow_c*)i_this)->_delete();
}

/* 800D8240-800D8260       .text daArrowExecute__FPv */
BOOL daArrowExecute(void* i_this) {
    /* Nonmatching */
    return ((daArrow_c*)i_this)->_execute();
}

/* 800D8260-800D8280       .text daArrowDraw__FPv */
BOOL daArrowDraw(void* i_this) {
    return ((daArrow_c*)i_this)->_draw();
}

/* 800D8280-800D8288       .text daArrowIsDelete__FPv */
BOOL daArrowIsDelete(void* i_this) {
    return TRUE;
}

actor_method_class daArrowMethodTable = {
    (process_method_func)daArrowCreate,
    (process_method_func)daArrowDelete,
    (process_method_func)daArrowExecute,
    (process_method_func)daArrowIsDelete,
    (process_method_func)daArrowDraw,
};

extern actor_process_profile_definition g_profile_ARROW = {
    /* LayerID      */ fpcLy_CURRENT_e,
    /* ListID       */ 9,
    /* ListPrio     */ fpcLy_CURRENT_e,
    /* ProcName     */ PROC_ARROW,
    /* Proc SubMtd  */ &g_fpcLf_Method.mBase,
    /* Size         */ sizeof(daArrow_c),
    /* SizeOther    */ 0,
    /* Parameters   */ 0,
    /* Leaf SubMtd  */ &g_fopAc_Method.base,
    /* Priority     */ 0x01BF,
    /* Actor SubMtd */ &daArrowMethodTable,
    /* Status       */ 0x00044000,
    /* Group        */ fopAc_ACTOR_e,
    /* CullType     */ fopAc_CULLBOX_CUSTOM_e,
};
