//
// Generated by dtk
// Translation Unit: d_a_disappear.cpp
//

#include "d/actor/d_a_disappear.h"
#include "f_op/f_op_actor.h"
#include "f_op/f_op_actor_mng.h"
#include "d/d_procname.h"
#include "d/d_com_inf_game.h"
#include "d/d_s_play.h"
#include "m_Do/m_Do_ext.h"

/* 800E79C0-800E79C8       .text daDisappear_Draw__FP15disappear_class */
static BOOL daDisappear_Draw(disappear_class*) {
    return TRUE;
}

/* 800E79C8-800E7AC0       .text daDisappear_Execute__FP15disappear_class */
static BOOL daDisappear_Execute(disappear_class* i_this) {
    if (i_this->mTimer != 0) {
        i_this->mTimer--;
        
        if (i_this->mTimer == 0) {
            s8 health = i_this->health; // TODO: add enum for disappear types (stored in health)

            if (health != 1 && health != 3) {
                if (health == 2) {
                    fopAcM_createItemForBoss(&i_this->current.pos, 0, i_this->current.roomNo, &i_this->current.angle);
                }
                else if (health >= 0x0A && health <= 0x0D) {
                    // Special type for Keese (ki) spawned in the Puppet Ganon fight.
                    if (health < 0x0D) {
                        static u32 ki_item_d[] = {
                            dItem_HEART_e,
                            L_MAGIC,
                            ARROW_10,
                        };

                        fopAcM_createItem(&i_this->current.pos, ki_item_d[health - 0xA], -1, -1, 0, NULL, 4);
                    }
                }
                else {
                    fopAcM_createIball(&i_this->current.pos, i_this->itemTableIdx, i_this->current.roomNo, &i_this->current.angle, i_this->mItemBitNo);
                }
            }
        }
    }
    else {
        fopAcM_delete(i_this);
    }

    return TRUE;
}

/* 800E7AC0-800E7AC8       .text daDisappear_IsDelete__FP15disappear_class */
static BOOL daDisappear_IsDelete(disappear_class*) {
    return TRUE;
}

/* 800E7AC8-800E7AD0       .text daDisappear_Delete__FP15disappear_class */
static BOOL daDisappear_Delete(disappear_class*) {
    return TRUE;
}

/* 800E7AD0-800E7DBC       .text set_disappear__FP15disappear_classf */
void set_disappear(disappear_class* i_this, float scale) {
    fopAcM_seStart(i_this, JA_SE_CM_MONS_EXPLODE, 0);

    cXyz particleScale(scale, scale, scale);
    i_this->mTimer = 58 + REG8_S(0);

    switch (i_this->health) {
        case 0x0:
        case 0x2:
        case 0xA:
        case 0xB:
        case 0xC:
        case 0xD:
            dComIfGp_particle_set(0x14, &i_this->current.pos, NULL, &particleScale);
        case 0x3:
            dComIfGp_particle_set(0x13, &i_this->current.pos, NULL, &particleScale);
            dComIfGp_particle_setStripes(0x15, &i_this->current.pos, NULL, &particleScale, 0xFF, 0x96);
            dComIfGp_particle_set(0x16, &i_this->current.pos, NULL, &particleScale);
            break;
        case 0x1:
            dComIfGp_particle_set(0x13, &i_this->current.pos, NULL, &particleScale);
            dComIfGp_particle_set(0x16, &i_this->current.pos, NULL, &particleScale);
            break;
        case 0x4:
            dComIfGp_particle_set(0x043C, &i_this->current.pos);
            dComIfGp_particle_set(0x043D, &i_this->current.pos);
            dComIfGp_particle_set(0x043E, &i_this->current.pos);
            break;
    }
}

/* 800E7DBC-800E7E60       .text daDisappear_Create__FP10fopAc_ac_c */
static s32 daDisappear_Create(fopAc_ac_c* i_this) {
    disappear_class* dis = static_cast<disappear_class*>(i_this);

    fopAcM_SetupActor(dis, disappear_class);

    dis->health = fopAcM_GetParam(dis) & 0xFF;
    f32 scaleMag = ((fopAcM_GetParam(dis) >> 8) & 0xFF) * 0.1f;

    dis->mItemBitNo = (fopAcM_GetParam(dis) >> 0x10) & 0xFF;
    if (dis->mItemBitNo == 0xFF) {
        dis->mItemBitNo = -1;
    }

    set_disappear(dis, scaleMag);

    return cPhs_COMPLEATE_e;
}

static actor_method_class l_daDisappear_Method = {
    (process_method_func)daDisappear_Create,
    (process_method_func)daDisappear_Delete,
    (process_method_func)daDisappear_Execute,
    (process_method_func)daDisappear_IsDelete,
    (process_method_func)daDisappear_Draw,
};

actor_process_profile_definition g_profile_DISAPPEAR = {
    /* LayerID      */ fpcLy_CURRENT_e,
    /* ListID       */ 0x0007,
    /* ListPrio     */ fpcPi_CURRENT_e,
    /* ProcName     */ PROC_DISAPPEAR,
    /* Proc SubMtd  */ &g_fpcLf_Method.base,
    /* Size         */ sizeof(disappear_class),
    /* SizeOther    */ 0,
    /* Parameters   */ 0,
    /* Leaf SubMtd  */ &g_fopAc_Method.base,
    /* Priority     */ 0x0188,
    /* Actor SubMtd */ &l_daDisappear_Method,
    /* Status       */ fopAcStts_UNK4000_e | fopAcStts_UNK40000_e,
    /* Group        */ fopAc_ACTOR_e,
    /* CullType     */ fopAc_CULLBOX_0_e,
};
