//
// Generated by dtk
// Translation Unit: d_a_jbo.cpp
//

#include "d/actor/d_a_jbo.h"
#include "d/actor/d_a_player.h"
#include "d/d_com_inf_game.h"
#include "d/d_kankyo.h"
#include "d/d_s_play.h"
#include "d/d_procname.h"


/* 00000078-00000108       .text nodeCallBack__FP7J3DNodei */
static BOOL nodeCallBack(J3DNode *i_node, int calcTiming) {
    if (calcTiming == J3DNodeCBCalcTiming_In) {
        J3DJoint* joint = reinterpret_cast<J3DJoint*>(i_node);
        s32 jntNo = joint->getJntNo();
        jbo_class* jbo = reinterpret_cast<jbo_class*>(j3dSys.getModel()->getUserArea());
        if (jbo != NULL && jntNo == 9) {
            MTXCopy(j3dSys.getModel()->getAnmMtx(jntNo), *calc_mtx);
            cXyz pos;
            pos.x = 0;
            pos.y = 0;
            pos.z = 0;
            MtxPosition(&pos, &jbo->mParticlePos);
        }
    }
    return TRUE;
}

/* 00000108-00000240       .text jbo_draw_SUB__FP9jbo_class */
void jbo_draw_SUB(jbo_class *i_this) {
    J3DModel *model = i_this->mpMorf->mpModel;
    model->getBaseScale()->x = i_this->scale.x;
    model->getBaseScale()->y = i_this->scale.y;
    model->getBaseScale()->z = i_this->scale.z;
    mDoMtx_stack_c::transS(i_this->current.pos.x, i_this->current.pos.y, i_this->current.pos.z);
    mDoMtx_stack_c::YrotM(i_this->shape_angle.y);
    mDoMtx_stack_c::XrotM(i_this->shape_angle.x);
    mDoMtx_stack_c::ZrotM(i_this->shape_angle.z);
    if (i_this->mAnimationSpeed) {
        cXyz scale;
        scale.x = REG8_F(1) + 1.1F;
        scale.y = REG8_F(2) + 1.0F;
        scale.z = REG8_F(3) + 0.9F;
        i_this->mAnimRotation += i_this->mAnimationSpeed;
        mDoMtx_stack_c::YrotM(i_this->mAnimRotation);
        mDoMtx_stack_c::scaleM(scale);
        mDoMtx_stack_c::YrotM(-i_this->mAnimRotation);
    }
    MTXCopy(mDoMtx_stack_c::now, model->getBaseTRMtx());
}

/* 00000240-000002C4       .text daJBO_Draw__FP9jbo_class */
static BOOL daJBO_Draw(jbo_class *i_this) {
    J3DModel *model = i_this->mpMorf->mpModel;
    if (i_this->mParam == 3)
        return TRUE;
    g_env_light.settingTevStruct(TEV_TYPE_ACTOR, &i_this->current.pos, &i_this->tevStr);
    g_env_light.setLightTevColorType(model, &i_this->tevStr);
    i_this->mpMorf->updateDL();
    return TRUE;
}

// time from link entering blub to being vomited out
#define JUMP_ANIMATION_TIME 70
enum Jbo_Resources {
    Jbo_bck_In1 = 4,
    Jbo_bck_Out1 = 5,
    Jbo_bck_Umareru1 = 6, // spawn animation

    Jbo_bmdm_jh = 9, // model
};

enum daJbo_State {
    daJbo_State_IDLE = 0,
    daJbo_State_WAIT_JUMP = 1,
    daJbo_State_SPAWN = 2,
};

/* 000002C4-00000584       .text jbo_move__FP9jbo_class */
void jbo_move(jbo_class *i_this) {
    u8 state = i_this->mState;
    switch (state) {
        case daJbo_State_IDLE: {
            if (dComIfGp_checkPlayerStatus0(0, daPyStts0_UNK80_e) && i_this->mSph.ChkCoHit()) {
                J3DAnmTransform* anm = (J3DAnmTransform*)dComIfG_getObjectRes("JBO", Jbo_bck_In1);
                i_this->mpMorf->setAnm(anm, J3DFrameCtrl::EMode_NONE, 0.0, 1.0, 0.0, -1.0, NULL);
                mDoAud_seStart(JA_SE_OBJ_JFLOWER_IN, &i_this->eyePos, 0, dComIfGp_getReverb(fopAcM_GetRoomNo(i_this)));
                g_dComIfG_gameInfo.play.mItemMagicCount += 4;
                i_this->mFramesUntilJump = JUMP_ANIMATION_TIME;
                i_this->mState += 1;
            }
            break;
        }
        case daJbo_State_WAIT_JUMP: {
            i_this->mAnimationSpeed = JUMP_ANIMATION_TIME - i_this->mFramesUntilJump;
            i_this->mAnimationSpeed *= 200;
            if (i_this->mFramesUntilJump == 1) {
                g_dComIfG_gameInfo.play.mpPlayer[0]->onForceVomitJump();
            }
            if (dComIfGp_checkPlayerStatus0(0, daPyStts0_UNK80000000_e)) {
                J3DAnmTransform* anm = (J3DAnmTransform*)dComIfG_getObjectRes("JBO", Jbo_bck_Out1);
                i_this->mpMorf->setAnm(anm, J3DFrameCtrl::EMode_NONE, 0.0, 1.0, 0.0, -1.0, NULL);
                mDoAud_seStart(JA_SE_OBJ_JFLOWER_OUT, &i_this->eyePos, 0, dComIfGp_getReverb(fopAcM_GetRoomNo(i_this)));
                i_this->mAnimationSpeed = 0;
                i_this->mAnimRotation = 0;
                JPABaseEmitter *emitter = dComIfGp_particle_setToon(0xa110, &i_this->mParticlePos);
                if (emitter != NULL) {
                    emitter->mGlobalPrmColor.a = 100;
                }
                if (i_this->mParam == 2) {
                    i_this->m2BA = 1;
                }
                i_this->mState = daJbo_State_IDLE;
            }
            break;
        }
        case daJbo_State_SPAWN: {
            J3DFrameCtrl &ctrl = i_this->mpMorf->mFrameCtrl;
            bool var = true;
            if (!ctrl.checkState(1) && ctrl.getRate() != 0.0f){
                var = false;
            }
            if (var) {
                i_this->mState = daJbo_State_IDLE;
            }
            break;
        }
    }
}

/* 00000584-00000698       .text daJBO_Execute__FP9jbo_class */
static BOOL daJBO_Execute(jbo_class* i_this) {
    if (i_this->mParam == 3) {
        if (dComIfGs_isEventBit(0x1801)) {
            i_this->mParam = 0;
            i_this->mSph.OnCoSPrmBit(cCcD_CoSPrm_Set_e);
        }
        return 1;
    }
    if (i_this->mFramesUntilJump != 0) {
        i_this->mFramesUntilJump--;
    }
    switch(i_this->m2BB) {
        case 0:
            jbo_move(i_this);
            break;
    }
    i_this->mpMorf->play(NULL, 0, 0);
    cXyz pos(i_this->current.pos);
    pos.y += 30.0;
    i_this->mSph.SetC(pos);
    i_this->mSph.SetR(55.0);
    g_dComIfG_gameInfo.play.mCcS.Set(&i_this->mSph);
    jbo_draw_SUB(i_this);
    return 1;
}

/* 00000698-000006A0       .text daJBO_IsDelete__FP9jbo_class */
static BOOL daJBO_IsDelete(jbo_class*) {
    return true;
}

/* 000006A0-000006D0       .text daJBO_Delete__FP9jbo_class */
static BOOL daJBO_Delete(jbo_class* i_this) {
    dComIfG_resDelete(&i_this->mPhs, "JBO");
    return 1;
}

/* 000006D0-0000081C       .text useHeapInit__FP10fopAc_ac_c */
static BOOL useHeapInit(fopAc_ac_c* i_actor) {
    jbo_class* i_this = (jbo_class*)i_actor;
    mDoExt_McaMorf* morf = new mDoExt_McaMorf(
        (J3DModelData *)dComIfG_getObjectRes("JBO", Jbo_bmdm_jh),
        /*callback1=*/ NULL,
        /*callback2=*/ NULL,
        (J3DAnmTransformKey *)dComIfG_getObjectRes("JBO", Jbo_bck_In1),
        J3DFrameCtrl::EMode_RESET,
        0.0f,
        0,
        -1,
        1,
        /*basAnm=*/ NULL,
        0,
        /*differedDlistFlag=*/ 0x11020203
    );
    i_this->mpMorf = morf;
    J3DModel *model;
    if (i_this->mpMorf == NULL || (model = i_this->mpMorf->mpModel) == NULL) {
        return FALSE;
    }
    model->setUserArea(reinterpret_cast<u32>(i_this));
    for (u16 i = 0; i < i_this->mpMorf->getModel()->getModelData()->getJointNum(); i++) {
        i_this->mpMorf->getModel()->getModelData()->getJointNodePointer(i)->setCallBack(nodeCallBack);
    }
    return TRUE;
}

/* 0000081C-00000A90       .text daJBO_Create__FP10fopAc_ac_c */
static cPhs_State daJBO_Create(fopAc_ac_c* actor) {
    fopAcM_SetupActor(actor, jbo_class);
    jbo_class* i_this = (jbo_class*)actor;
    cPhs_State state = dComIfG_resLoad(&i_this->mPhs, "JBO");
    if (state == cPhs_COMPLEATE_e) {
        if (!fopAcM_entrySolidHeap(actor, &useHeapInit, 0x1c20)) {
            return cPhs_ERROR_e;
        } else {
            i_this->mParam = (u8)actor->base.mParameters;
            if (i_this->mParam == 0xFF) {
                i_this->mParam = 0;
            }

            if (REG8_S(9) != 0) {
                i_this->mParam = REG8_S(9);
            }
            i_this->cullMtx = i_this->mpMorf->getModel()->getBaseTRMtx();
            i_this->attention_info.flags = 0;
            i_this->mStts.Init(0xff, 0xff, i_this);
            static dCcD_SrcSph co_sph_src = {
                // dCcD_SrcGObjInf
                {
                    /* Flags             */ 0,
                    /* SrcObjAt  Type    */ 0,
                    /* SrcObjAt  Atp     */ 0,
                    /* SrcObjAt  SPrm    */ 0,
                    /* SrcObjTg  Type    */ 0,
                    /* SrcObjTg  SPrm    */ 0,
                    /* SrcObjCo  SPrm    */ cCcD_CoSPrm_VsEnemy_e|cCcD_CoSPrm_IsOther_e|cCcD_CoSPrm_Set_e,
                    /* SrcGObjAt Se      */ 0,
                    /* SrcGObjAt HitMark */ 0,
                    /* SrcGObjAt Spl     */ 0,
                    /* SrcGObjAt Mtrl    */ 0,
                    /* SrcGObjAt SPrm    */ 0,
                    /* SrcGObjTg Se      */ 0,
                    /* SrcGObjTg HitMark */ 0,
                    /* SrcGObjTg Spl     */ 0,
                    /* SrcGObjTg Mtrl    */ 0,
                    /* SrcGObjTg SPrm    */ 0,
                    /* SrcGObjCo SPrm    */ 0,
                },
                // cM3dGSphS
                {
                    /* Center */ 0.0f, 0.0f, 0.0f,
                    /* Radius */ 15.0f,
                },
            };
            i_this->mSph.Set(co_sph_src);
            i_this->mSph.SetStts(&i_this->mStts);
            if (i_this->mParam == 3) {
                i_this->actor_status &= ~fopAcStts_SHOWMAP_e;
                i_this->mSph.OffCoSPrmBit(cCcD_CoSPrm_Set_e);
            }
            if (i_this->mParam == 1) {
                J3DAnmTransform* pAnimRes = (J3DAnmTransform*) dComIfG_getObjectRes("JBO", Jbo_bck_Umareru1);
                i_this->mpMorf->setAnm(pAnimRes, J3DFrameCtrl::EMode_NONE, 0.0, 1.0, 0.0, -1.0, NULL);
                mDoAud_seStart(JA_SE_CM_BV_BASE_POPUP, &i_this->eyePos, 0, dComIfGp_getReverb(fopAcM_GetRoomNo(i_this)));
                i_this->mState = daJbo_State_SPAWN;
            }
            i_this->gbaName = 0x21;
            jbo_draw_SUB(i_this);
        }
    }
    return state;
}


static actor_method_class l_daJBO_Method = {
    (process_method_func)daJBO_Create,
    (process_method_func)daJBO_Delete,
    (process_method_func)daJBO_Execute,
    (process_method_func)daJBO_IsDelete,
    (process_method_func)daJBO_Draw,
};

actor_process_profile_definition g_profile_JBO = {
    /* LayerID      */ fpcLy_CURRENT_e,
    /* ListID       */ 0x0007,
    /* ListPrio     */ fpcPi_CURRENT_e,
    /* ProcName     */ PROC_JBO,
    /* Proc SubMtd  */ &g_fpcLf_Method.base,
    /* Size         */ sizeof(jbo_class),
    /* SizeOther    */ 0,
    /* Parameters   */ 0,
    /* Leaf SubMtd  */ &g_fopAc_Method.base,
    /* Priority     */ 0x00C8,
    /* Actor SubMtd */ &l_daJBO_Method,
    /* Status       */ fopAcStts_SHOWMAP_e | fopAcStts_CULL_e | fopAcStts_UNK40000_e,
    /* Group        */ fopAc_ENV_e,
    /* CullType     */ fopAc_CULLBOX_0_e,
};
