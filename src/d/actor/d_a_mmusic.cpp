//
// Generated by dtk
// Translation Unit: d_a_mmusic.cpp
//

#include "d/actor/d_a_mmusic.h"
#include "JAZelAudio/JAIZelBasic.h"
#include "SSystem/SComponent/c_math.h"
#include "d/d_com_inf_game.h"
#include "d/d_item_data.h"
#include "d/d_particle.h"
#include "d/d_save.h"
#include "dolphin/mtx/mtx.h"
#include "dolphin/types.h"
#include "f_op/f_op_actor_mng.h"
#include "m_Do/m_Do_mtx.h"

/* 00000078-0000009C       .text solidHeapCB__Q28daMmusic5Act_cFP10fopAc_ac_c */
BOOL daMmusic::Act_c::solidHeapCB(fopAc_ac_c* i_this) {
    return ((Act_c*)i_this)->create_heap();
}

/* 0000009C-000000A4       .text create_heap__Q28daMmusic5Act_cFv */
bool daMmusic::Act_c::create_heap() {
    return true;
}

/* 000000A4-0000013C       .text Macore_is_playing__Q28daMmusic5Act_cFv */
BOOL daMmusic::Act_c::Macore_is_playing() {
    if (!(!dComIfGs_isStageBossEnemy(7) &&
          !g_dComIfG_gameInfo.save.mSavedata.mEvent.isEventBit(0x2910) &&
          !g_dComIfG_gameInfo.save.mSavedata.mEvent.isEventBit(0x2e02) &&
          !g_dComIfG_gameInfo.save.mSavedata.mEvent.isEventBit(0x1610) &&
          dComIfGs_checkGetItem(LV3_SWORD)))
    {
        return FALSE;
    }
    return TRUE;
}

/* 0000013C-000001A4       .text set_mtx__Q28daMmusic5Act_cFv */
void daMmusic::Act_c::set_mtx() {
    PSMTXTrans(mDoMtx_stack_c::now, current.pos.x, current.pos.y, current.pos.z);
    mDoMtx_ZXYrotM(mDoMtx_stack_c::now, shape_angle.x, shape_angle.y, shape_angle.z);
    PSMTXCopy(mDoMtx_stack_c::now, field_0x2A4);
}

/* 000001A4-00000268       .text _create__Q28daMmusic5Act_cFv */
s32 daMmusic::Act_c::_create() {
     /* Nonmatching */
    unsigned int uVar1;
    s32 uVar3;
    if ((mCondition & 8) == 0) {
        if (this != NULL) {
            _delete();
        }
        mCondition = mCondition | 8;
    }
    uVar3 = 4;
    uVar1 = fopAcM_entrySolidHeap((fopAc_ac_c*)this, solidHeapCB, 0);
    if (uVar1 != 0) {
        set_mtx();
        mCullMtx = field_0x2A4;
        field_0x298 = Macore_is_playing();
        fopAcM_setCullSizeSphere((fopAc_ac_c*)this, 0, 0, 0, 300.0f);
        init_se();
    } else {
        uVar3 = 5;
    }
    return uVar3;
}

/* 00000268-000002B4       .text _delete__Q28daMmusic5Act_cFv */
BOOL daMmusic::Act_c::_delete() {
    if ((unsigned int)field_0x2A0 != NULL) {
        ((JPABaseEmitter*)field_0x2A0)->becomeInvalidEmitter();
        field_0x2A0 = NULL;
    }
    delete_se();
    return TRUE;
}

/* 000002B4-000002C0       .text init_se__Q28daMmusic5Act_cFv */
void daMmusic::Act_c::init_se() {
    field_0x2D4 = 120;
}

/* 000002C0-000003D0       .text manage_se__Q28daMmusic5Act_cFi */
void daMmusic::Act_c::manage_se(int param_1) {
    /* Nonmatching */
    if ((*JAIZelBasic::zel_basic).checkCbPracticePlay() == 0) {
        if (0 < field_0x2D4) {
            field_0x2D4 -= 1;
        }
        if ((field_0x2D4) == 0) {
            (*JAIZelBasic::zel_basic).cbPracticePlay((Vec*)&current.pos);
            (field_0x2D4) = (short)(cM_rndF(1.0) * 60.0 + 120.0);
        } else if ((param_1 == 0) && ((field_0x29C) == 1)) {
            *(unsigned int*)((field_0x2A0) + 0x20c) = *(unsigned int*)((field_0x2A0) + 0x20c) | 1;
            field_0x29C = NULL;
        }
    } else if ((param_1 == 0) && ((field_0x29C) == 0)) {
        *(unsigned int*)((field_0x2A0) + 0x20c) =
            *(unsigned int*)((field_0x2A0) + 0x20c) & 0xfffffffe;
        field_0x29C = NULL;
    }
}

/* 000003D0-000003FC       .text delete_se__Q28daMmusic5Act_cFv */
void daMmusic::Act_c::delete_se() {
    (*JAIZelBasic::zel_basic).cbPracticeStop();
}

/* 000003FC-00000554       .text _execute__Q28daMmusic5Act_cFv */
bool daMmusic::Act_c::_execute() {
    /* Nonmatching */
    JPABaseEmitter* pJVar1;
    s32 iVar2;
    int uVar3;

    if (field_0x2A0 && !field_0x298) {
        set_mtx();
        // pJVar1 = g_dComIfG_gameInfo.play.mParticle.set(0, 0x826c, (cXyz*)(this + 0x1f8), 0, 0,
        // 255, 0, -1, 0, 0, 0);
        *(JPABaseEmitter**)(field_0x2A0) = pJVar1;
        if (pJVar1 != 0) {
            // JPASetRMtxTVecfromMtx(*(Mtx*)(this + 0x2a4), *(Mtx*)(*(int*)(field_0x2A0) + 0x1a8),
            //                       *(cXyz*)(*(int*)(field_0x2A0) + 0x1e4));
            field_0x298 = TRUE;
            field_0x29C = 1;
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
    } else if (field_0x2A0) {
        field_0x298 = Macore_is_playing();
    } else {
        iVar2 = fopAcM_cullingCheck((fopAc_ac_c*)this);
        if (iVar2 == 0) {
            if (!field_0x29C) {
                *(unsigned int*)(*(int*)(field_0x2A0) + 0x20c) =
                    *(unsigned int*)(*(int*)(field_0x2A0) + 0x20c) | 1;
                field_0x29C = TRUE;
            }
        } else if (field_0x29C) {
            *(unsigned int*)(*(int*)(field_0x2A0) + 0x20c) =
                *(unsigned int*)(*(int*)(field_0x2A0) + 0x20c) & 0xfffffffe;
            field_0x29C = FALSE;
        }
        manage_se(iVar2);
    }
    return 1;
}

/* 00000554-0000055C       .text _draw__Q28daMmusic5Act_cFv */
bool daMmusic::Act_c::_draw() {
    return true;
}
