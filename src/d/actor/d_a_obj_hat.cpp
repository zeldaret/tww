//
// Generated by dtk
// Translation Unit: d_a_obj_hat.cpp
//

#include "d/actor/d_a_obj_hat.h"
#include "d/actor/d_a_npc_roten.h"
#include "d/d_a_obj.h"
#include "d/d_com_inf_game.h"
#include "d/d_kankyo.h"
#include "d/d_procname.h"
#include "d/res/res_ro.h"
#include "JSystem/J3DGraphAnimator/J3DModel.h"


// const char daObjHat_c::m_arcname[] = "ObjHat";

/* 00000078-00000184       .text __ct__10daObjHat_cFv */
daObjHat_c::daObjHat_c() {
    u32 hatno = getPrmHatNo();
    mHatNo = hatno;
    mState = 0;
    /* Nonmatching */
}

/* 000003AC-000003CC       .text CheckCreateHeap__FP10fopAc_ac_c */
static BOOL CheckCreateHeap(fopAc_ac_c* actor) {
    return ((daObjHat_c*)actor)->createHeap();
    /* Nonmatching */
}

/* 000003CC-0000045C       .text _create__10daObjHat_cFv */
s32 daObjHat_c::_create() {
    // if (this->actor_condition & )
    fopAcM_SetupActor(this, daObjHat_c);

    int var = dComIfG_resLoad(&mPhs, "Ro");

    if (var == cPhs_COMPLEATE_e) {
        if (!fopAcM_entrySolidHeap((fopAc_ac_c*)this, &CheckCreateHeap, 0uL)) {
            return cPhs_ERROR_e;
        } else {
            return createInit();
        }
    }

    /* Nonmatching */
}

static const int l_bmd_ix_tbl[] = {RO_BDL_RO_HAT, RO_BDL_RO_HAT2, RO_BDL_RO_HAT3, RO_BDL_RO_HAT};
static const int l_bck_ix_tbl[] = {RO_INDEX_BCK_HAT_WID, RO_BCK_HAT2_WIND, RO_BCK_HAT3_WID,
                                   RO_BCK_HAT_WID};
static dCcD_SrcCyl l_cyl_src = {
    // dCcD_SrcGObjInf
    {
        /* Flags             */ 0,
        /* SrcObjAt  Type    */ 0,//AT_TYPE_UNK1000,
        /* SrcObjAt  Atp     */ 0,
        /* SrcObjAt  SPrm    */ 0,
        /* SrcObjTg  Type    */ AT_TYPE_WIND,
        /* SrcObjTg  SPrm    */ cCcD_TgSPrm_Set_e | cCcD_TgSPrm_IsEnemy_e,
        /* SrcObjCo  SPrm    */ cCcD_CoSPrm_Set_e | cCcD_CoSPrm_IsOther_e | cCcD_CoSPrm_VsGrpAll_e,
        /* SrcGObjAt Se      */ 0,
        /* SrcGObjAt HitMark */ 0,
        /* SrcGObjAt Spl     */ 0,
        /* SrcGObjAt Mtrl    */ 0,
        /* SrcGObjAt SPrm    */ 0,//AT_TYPE_WIND,
        /* SrcGObjTg Se      */ 0,
        /* SrcGObjTg HitMark */ 0,
        /* SrcGObjTg Spl     */ 0,
        /* SrcGObjTg Mtrl    */ 0,
        /* SrcGObjTg SPrm    */ dCcG_TgSPrm_NoHitMark_e | dCcG_TgSPrm_NoConHit_e,
        /* SrcGObjCo SPrm    */ 0,
    },
    // cM3dGCylS
    {
        /* Center */ 0.0f,
        0.0f,
        0.0f,
        /* Radius */ 70.0f,
        /* Height */ 80.0f,
    },
};

/* 0000045C-000005D4       .text createHeap__10daObjHat_cFv */
BOOL daObjHat_c::createHeap() {
    J3DModelData* pModelData = (J3DModelData*)dComIfG_getObjectIDRes("Ro", l_bmd_ix_tbl[this->mHatNo]);
    if (pModelData == NULL) {
        return FALSE;
    } else {
        mDoExt_McaMorf* morf = new mDoExt_McaMorf(
            pModelData, NULL, NULL,
            (J3DAnmTransformKey*)dComIfG_getObjectIDRes("Ro", l_bck_ix_tbl[mHatNo]),
            J3DFrameCtrl::LOOP_REPEAT_e, 1.0f, 0, -1, 1, NULL, 0x80000, 0x37441422);

        this->mpMorf = morf;
        if (this->mpMorf == NULL || this->mpMorf->getModel() == NULL) {
            return FALSE;
        } else {
            this->model = this->mpMorf->getModel();
            mAcchCir.SetWall(30.0f, 30.0f);
            mAcch.Set(&current.pos, &old.pos, this, 1, &mAcchCir, &speed,
                      &current.angle, &shape_angle);
            return TRUE;
        }
    }
    return FALSE;
}

/* 000005D4-000006AC       .text createInit__10daObjHat_cFv */
s32 daObjHat_c::createInit() {
    mStts.Init(2, 0xff, this);
    mCyl.Set(l_cyl_src);
    mCyl.SetStts(&mStts);
    cullMtx = model->mBaseTransformMtx;
    fopAcM_setCullSizeBox(this, -50.0f, 0.0f, -50.0f, 50.0f, 200.0f, 50.0f);
    gravity = -5.0f;

    fopAc_ac_c* parent;
    int res = fopAcM_SearchByID(parentActorID, &parent);
    if ((res != 0) && (parent != NULL)) {
        setSpeed(static_cast<daNpcRoten_c*>(parent)->getWindVec());
    }
    setMtx();
    return cPhs_COMPLEATE_e;
}

/* 000006AC-000006DC       .text _delete__10daObjHat_cFv */
bool daObjHat_c::_delete() {
    dComIfG_resDelete(&mPhs, "Ro");
    return TRUE;
}

/* 000006DC-0000073C       .text _draw__10daObjHat_cFv */
bool daObjHat_c::_draw() {
    g_env_light.settingTevStruct(TEV_TYPE_ACTOR, &current.pos, &tevStr);
    g_env_light.setLightTevColorType(model, &tevStr);
    mpMorf->updateDL();
    return TRUE;
}

static daObjHat_c::MoveFunc_t moveProc[] = {
    &daObjHat_c::executeNormal,
};


/* 0000073C-00000884       .text _execute__10daObjHat_cFv */
bool daObjHat_c::_execute() {
    // dCcD_Sph::~dCcD_Sp

    (this->*moveProc[this->mState])();
    f32 xspeed = this->mSpeed.x * this->speedF;
    f32 ymove = this->speed.y + this->gravity;
    f32 zspeed = this->mSpeed.z * this->speedF;
    // because downwards vector quantity has negative value
    if (ymove < this->maxFallSpeed) {
        ymove = this->maxFallSpeed;
    }

    speed.x = xspeed;
    speed.y = ymove;
    speed.z = zspeed;
    fopAcM_posMove(this, mStts.GetCCMoveP());
    mAcch.CrrPos(g_dComIfG_gameInfo.play.mBgS);
    if ((this->mAcch.m_flags & dBgS_Acch::WALL_HIT) != 0) {
        this->speedF = 0;
    }
    if ((this->mAcch.m_flags & dBgS_Acch::GROUND_HIT) != 0) {
        cLib_addCalc(&this->speedF, 0.0, 0.3, 1000.0, 1.0);
    }

    mCyl.SetC(this->current.pos);
    g_dComIfG_gameInfo.play.mCcS.Set(&mCyl);
    u32 res = mCyl.ChkTgHit();
    if (res != 0) {
        setSpeed(*mCyl.GetTgRVecP());
    }

    setMtx();
    return TRUE;
}

/* 00000884-00000888       .text executeNormal__10daObjHat_cFv */
void daObjHat_c::executeNormal() { /* empty? */ }

/* 00000888-000008B4       .text getPrmHatNo__10daObjHat_cFv */
u32 daObjHat_c::getPrmHatNo() {
    return daObj::PrmAbstract(this, PRM_SWSAVE_W, PRM_SWSAVE_S) & 3;
}

/* 000008B4-00000964       .text setMtx__10daObjHat_cFv */
void daObjHat_c::setMtx() {
    model->mBaseScale = this->scale;
    MTXTrans(mDoMtx_stack_c::now, this->current.pos.x, this->current.pos.y,
             this->current.pos.z);
    mDoMtx_YrotM(mDoMtx_stack_c::now, this->current.angle.y + 0x4000);
    mDoMtx_XrotM(mDoMtx_stack_c::now, this->current.angle.x);
    mDoMtx_ZrotM(mDoMtx_stack_c::now, this->current.angle.z + 0x4000);
    MTXCopy(mDoMtx_stack_c::now, this->model->mBaseTransformMtx);
}

/* 00000964-00000A20       .text setSpeed__10daObjHat_cF4cXyz */
void daObjHat_c::setSpeed(cXyz speed) {
    speed.y = 0;
    speed = speed.normZP();

    this->mSpeed = speed;

    fopAcM_SetSpeedF(this, 20.0f);

    speed.x *= 20.0f;
    speed.y = 50.0f;
    speed.z *= 20.0f;

    fopAcM_SetSpeed(this, speed.x, speed.y, speed.z);
}

/* 00000A20-00000A40       .text daSampleCreate__FPv */
static s32 daSampleCreate(void* arg) {
    static_cast<daObjHat_c*>(arg)->_create();
}

/* 00000A40-00000A60       .text daSampleDelete__FPv */
static BOOL daSampleDelete(void* arg) {
    static_cast<daObjHat_c*>(arg)->_delete();
}

/* 00000A60-00000A80       .text daSampleExecute__FPv */
static BOOL daSampleExecute(void* arg) {
    static_cast<daObjHat_c*>(arg)->_execute();
}

/* 00000A80-00000AA0       .text daSampleDraw__FPv */
static BOOL daSampleDraw(void* arg) {
    static_cast<daObjHat_c*>(arg)->_draw();
}

/* 00000AA0-00000AA8       .text daSampleIsDelete__FPv */
static BOOL daSampleIsDelete(void* arg) {
    return 1;
}

static actor_method_class daSampleMethodTable = {
    (process_method_func)daSampleCreate,
    (process_method_func)daSampleDelete,
    (process_method_func)daSampleExecute,
    (process_method_func)daSampleIsDelete,
    (process_method_func)daSampleDraw,
};

actor_process_profile_definition g_profile_OBJ_HAT = {
    /* LayerID      */ fpcLy_CURRENT_e,
    /* ListID       */ 0x0007,
    /* ListPrio     */ fpcPi_CURRENT_e,
    /* ProcName     */ PROC_OBJ_HAT,
    /* Proc SubMtd  */ &g_fpcLf_Method.base,
    /* Size         */ sizeof(daObjHat_c),
    /* SizeOther    */ 0,
    /* Parameters   */ 0,
    /* Leaf SubMtd  */ &g_fopAc_Method.base,
    /* Priority     */ 0x01C8,
    /* Actor SubMtd */ &daSampleMethodTable,
    /* Status       */ fopAcStts_CULL_e | fopAcStts_UNK40000_e,
    /* Group        */ fopAc_ACTOR_e,
    /* CullType     */ fopAc_CULLBOX_CUSTOM_e,
};
