//
// Generated by dtk
// Translation Unit: d_a_warpgn.cpp
//

#include "d/dolzel_rel.h" // IWYU pragma: keep
#include "d/actor/d_a_warpgn.h"
#include "d/d_lib.h"
#include "d/d_procname.h"
#include "d/d_priority.h"
#include "d/res/res_gmjwp.h"

const char daWarpgn_c::m_arcname[] = "Gmjwp";
const u32 daWarpgn_c::m_heapsize = 0x3000;

typedef void (daWarpgn_c::*EventInitFunc)(int);
EventInitFunc event_init_tbl[] = {
    &daWarpgn_c::initWait,
    &daWarpgn_c::initStartWarp,
    &daWarpgn_c::initWarp,
    &daWarpgn_c::initWarpArrive,
    &daWarpgn_c::initWarpArriveEnd,
    &daWarpgn_c::initAppear
};

typedef BOOL (daWarpgn_c::*EventActionFunc)(int);
EventActionFunc event_action_tbl[] = {
    &daWarpgn_c::actWait,
    &daWarpgn_c::actStartWarp,
    &daWarpgn_c::actWarp,
    &daWarpgn_c::actWarpArrive,
    &daWarpgn_c::actWarpArriveEnd,
    &daWarpgn_c::actAppear
};

/* 00000078-00000120       .text _delete__10daWarpgn_cFv */
bool daWarpgn_c::_delete() {
    if (field_0x2AC != NULL) {
        field_0x2AC->becomeInvalidEmitter();
        field_0x2AC = NULL;
    }

    if (field_0x2B0 != NULL) {
        field_0x2B0->becomeInvalidEmitter();
        field_0x2B0 = NULL;
    }

    if (field_0x2B4 != NULL) {
        field_0x2B4->becomeInvalidEmitter();
        field_0x2B4 = NULL;
    }

    dComIfG_resDelete(&field_0x290, m_arcname);
    return true;
}

/* 00000120-00000140       .text CheckCreateHeap__FP10fopAc_ac_c */
static BOOL CheckCreateHeap(fopAc_ac_c* i_this) {
    return ((daWarpgn_c*)i_this)->CreateHeap();
}

/* 00000140-00000570       .text CreateHeap__10daWarpgn_cFv */
BOOL daWarpgn_c::CreateHeap() {
    J3DModelData* modelData = (J3DModelData*) dComIfG_getObjectRes(m_arcname, GMJWP_BDL_GMJWP00);
    JUT_ASSERT(0xCF, modelData != NULL);

    field_0x298 = mDoExt_J3DModel__create(modelData, 0x80000, 0x11000222);
    if (field_0x298 == NULL) {
        return FALSE;
    }

    J3DAnmTextureSRTKey* pbtk = (J3DAnmTextureSRTKey*) dComIfG_getObjectRes(m_arcname, GMJWP_BTK_GMJWP00);
    JUT_ASSERT(0xDE, pbtk != NULL);
    field_0x29C = new mDoExt_btkAnm(); 
    if ((field_0x29C == NULL) || field_0x29C->init(modelData, pbtk, true, J3DFrameCtrl::EMode_LOOP, 1.0f, 0, -1, false, 0) == 0) {
        return FALSE;
    }
    field_0x29C->setPlaySpeed(1.0f);

    pbtk = (J3DAnmTextureSRTKey*) dComIfG_getObjectRes(m_arcname, GMJWP_BTK_GMJWP02);
    JUT_ASSERT(0xED, pbtk != NULL);
    field_0x2A0 = new mDoExt_btkAnm();
    if ((field_0x2A0 == NULL) || field_0x2A0->init(modelData, pbtk, true, J3DFrameCtrl::EMode_NONE, 1.0f, 0, -1, false, 0) == 0) {
        return FALSE;
    }
    field_0x2A0->setPlaySpeed(0.0f);

    J3DAnmTevRegKey* pbrk = (J3DAnmTevRegKey *) dComIfG_getObjectRes(m_arcname, GMJWP_BRK_GMJWP01);
    JUT_ASSERT(0xFF, pbrk != NULL);
    field_0x2A4 = new mDoExt_brkAnm();
    if (field_0x2A4 == NULL || field_0x2A4->init(modelData, pbrk, true, J3DFrameCtrl::EMode_NONE, 1.0f, 0, -1, false, 0) == 0) {
        return FALSE;
    }
    field_0x2A4->setPlaySpeed(0.0f);

    J3DAnmTransform* pbck = (J3DAnmTransform*) dComIfG_getObjectRes(m_arcname, GMJWP_BCK_GMJWP01);
    JUT_ASSERT(0x10F, pbck != NULL);
    field_0x2A8 = new mDoExt_bckAnm();
    if (field_0x2A8 == NULL || field_0x2A8->init(modelData, pbck, true, J3DFrameCtrl::EMode_NONE, 1.0f, 0, -1, false) == 0) {
        return FALSE;
    }
    field_0x2A8->setPlaySpeed(0.0f);

    return TRUE;
}

/* 000005B8-000007D0       .text CreateInit__10daWarpgn_cFv */
void daWarpgn_c::CreateInit() {
    cullMtx = field_0x298->getBaseTRMtx();
    fopAcM_setCullSizeBox(this, -400.0f, 0.0f, -400.0f, 400.0f, 2000.0f, 400.0f);
    fopAcM_setCullSizeFar(this, 1.0f);
    set_mtx();
    
    field_0x2AC = dComIfGp_particle_set(dPa_name::ID_SCENE_83FD, &current.pos);
    field_0x2B0 = dComIfGp_particle_set(dPa_name::ID_SCENE_83FE, &current.pos);
    field_0x2B4 = dComIfGp_particle_setProjection(dPa_name::ID_SCENE_C3FC, &current.pos);

    if (field_0x2AC != NULL) {
        field_0x2AC->stopCreateParticle();
    }

    if (field_0x2B0 != NULL) {
        field_0x2B0->stopCreateParticle();
    }

    if (field_0x2B4 != NULL) {
        field_0x2B4->stopCreateParticle();
    }

    field_0x2C8 = dComIfGp_evmng_getEventIdx("TO_MAJYUU_WARP");
    field_0x2CA = dComIfGp_evmng_getEventIdx("APPEAR_WARP");
    field_0x2B8 = daWarpgn_prm::getSwitchNo(this);

    if (checkValidWarp() != FALSE) {
        field_0x2BC = true;
        field_0x2CA = -1;
    }
    field_0x2C0 = daWarpgn_prm::getSceneNo(this);
    dKy_tevstr_init(&field_0x2D8, fopAcM_GetRoomNo(this), 0xFF);
}

/* 000007D0-000008F4       .text _create__10daWarpgn_cFv */
cPhs_State daWarpgn_c::_create() {
    cPhs_State rt = cPhs_ERROR_e;

    fopAcM_SetupActor(this, daWarpgn_c);

    rt = dComIfG_resLoad(&field_0x290, m_arcname);

    if (rt == cPhs_COMPLEATE_e) {
        if (!fopAcM_entrySolidHeap(this, CheckCreateHeap, m_heapsize)) {
            return cPhs_ERROR_e;
        }
        CreateInit();
    }

    return rt;
}

/* 000008F4-00000964       .text set_mtx__10daWarpgn_cFv */
void daWarpgn_c::set_mtx() {
    field_0x298->setBaseScale(scale);
    PSMTXTrans(mDoMtx_stack_c::now, current.pos.x, current.pos.y, current.pos.z);
    field_0x298->setBaseTRMtx(mDoMtx_stack_c::now);
}

/* 00000964-00000A78       .text _execute__10daWarpgn_cFv */
bool daWarpgn_c::_execute() {
    /* Nonmatching */
}

/* 00000A78-00000B88       .text normal_execute__10daWarpgn_cFv */
void daWarpgn_c::normal_execute() {
    /* Nonmatching */
}

/* 00000B88-00000C10       .text demo_execute__10daWarpgn_cFv */
BOOL daWarpgn_c::demo_execute() {
    dDemo_actor_c* actor = dComIfGp_demo_getActor(demoActorID);
    if (actor != NULL) {
        field_0x2D0 = actor->getShapeId();
        if (field_0x2D0 == 0) {
            anim_play(0);
            return TRUE;
        } 
        
        if (field_0x2D0 == 1) {
            anim_play(1);
        }
    }
    return TRUE;
}

/* 00000C10-00000D2C       .text demo_proc__10daWarpgn_cFv */
void daWarpgn_c::demo_proc() {
    /* Nonmatching */
    static char* action_table[] = {
        "WAIT",
        "WARP",
        "WARP_ARRIVE",
        "WARP_ARRIVE_END",
        "START_WARP",
        "APPEAR"
    };
}

/* 00000D2C-00000D30       .text initWait__10daWarpgn_cFi */
void daWarpgn_c::initWait(int) {
    /* Nonmatching */
}

/* 00000D30-00000D58       .text actWait__10daWarpgn_cFi */
BOOL daWarpgn_c::actWait(int) {
    anim_play(0);
    return TRUE;
}

/* 00000D58-00000E14       .text initStartWarp__10daWarpgn_cFi */
void daWarpgn_c::initStartWarp(int) {
    dComIfGp_evmng_setGoal(&current.pos);

    if (field_0x29C != NULL) {
        field_0x29C->setFrame(0.0f);
    }

    if (field_0x2A0 != NULL) {
        field_0x2A0->setFrame(0.0f);
    }

    if (field_0x2AC != NULL) {
        field_0x2AC->playCreateParticle();
    }

    if (field_0x2B0 != NULL) {
        field_0x2B0->playCreateParticle();
    }

    if (field_0x2B4 != NULL) {
        field_0x2B4->playCreateParticle();
    }
}

/* 00000E14-00000E3C       .text actStartWarp__10daWarpgn_cFi */
BOOL daWarpgn_c::actStartWarp(int) {
    anim_play(0);
    return TRUE;
}

/* 00000E3C-00000E94       .text initWarp__10daWarpgn_cFi */
void daWarpgn_c::initWarp(int) {
    mDoAud_seStart(JA_SE_LK_GN_WAPR_U_IN);
}

/* 00000E94-00000EBC       .text actWarp__10daWarpgn_cFi */
BOOL daWarpgn_c::actWarp(int) {
    anim_play(0);
    return TRUE;
}

/* 00000EBC-00000F6C       .text initWarpArrive__10daWarpgn_cFi */
void daWarpgn_c::initWarpArrive(int) {
    set_end_anim();
    if (field_0x2AC != NULL) {
        field_0x2AC->playCreateParticle();
    }

    if (field_0x2B0 != NULL) {
        field_0x2B0->playCreateParticle();
    }

    if (field_0x2B4 != NULL) {
        field_0x2B4->playCreateParticle();
    }

    mDoAud_seStart(JA_SE_LK_GN_WAPR_D_OUT);
}

/* 00000F6C-00000F94       .text actWarpArrive__10daWarpgn_cFi */
BOOL daWarpgn_c::actWarpArrive(int) {
    anim_play(0);
    return TRUE;
}

/* 00000F94-00000F98       .text initWarpArriveEnd__10daWarpgn_cFi */
void daWarpgn_c::initWarpArriveEnd(int) {
    /* Nonmatching */
}

/* 00000F98-00001000       .text actWarpArriveEnd__10daWarpgn_cFi */
BOOL daWarpgn_c::actWarpArriveEnd(int) {
    BOOL rt = FALSE;
    anim_play(4);
    if ((field_0x2A0 != NULL) && (field_0x2A0->getFrame() < 0.5f)) {
        rt = TRUE;
    }
    return rt;
}

/* 00001000-0000100C       .text initAppear__10daWarpgn_cFi */
void daWarpgn_c::initAppear(int) {
    field_0x2D4 = 100;
}

/* 0000100C-000010BC       .text actAppear__10daWarpgn_cFi */
BOOL daWarpgn_c::actAppear(int) {
    BOOL rt = FALSE;
    if (cLib_calcTimer(&field_0x2D4) == 0) {
        if (field_0x2AC != NULL) {
            field_0x2AC->playCreateParticle();
        }

        if (field_0x2B0 != NULL) {
            field_0x2B0->playCreateParticle();
        }

        if (field_0x2B4 != NULL) {
            field_0x2B4->playCreateParticle();
        }
        field_0x2D4 = 100;
        rt = TRUE;
    }
    anim_play(1);
    field_0x388 = true;
    return rt;
}

/* 000010BC-0000114C       .text eventOrder__10daWarpgn_cFv */
void daWarpgn_c::eventOrder() {
    /* Nonmatching */
    if (field_0x2C4 == 2) {
        fopAcM_orderOtherEventId(this, field_0x2C8);
        eventInfo.onCondition(dEvtCnd_UNK2_e);
    } else if (field_0x2C4 == 1) {
        fopAcM_orderOtherEventId(this, field_0x2CA);
        eventInfo.onCondition(dEvtCnd_UNK2_e);
    }
}

/* 0000114C-00001258       .text checkOrder__10daWarpgn_cFv */
void daWarpgn_c::checkOrder() {
    if (eventInfo.checkCommandDemoAccrpt()) {
        BOOL res = dComIfGp_evmng_startCheck(field_0x2C8);
        if ((res != FALSE) && (field_0x2C4 != 0)) {
            field_0x2C4 = 0;
        }

        res = dComIfGp_evmng_startCheck(field_0x2CA);
        if ((res != FALSE) && (field_0x2C4 != 0)) {
            field_0x2C4 = 0;
        }

        res = dComIfGp_evmng_endCheck(field_0x2C8);
        if (res) {
            dLib_setNextStageBySclsNum(field_0x2C0 & 0xFF, fopAcM_GetRoomNo(this));
        }

        res = dComIfGp_evmng_endCheck(field_0x2CA);
        if (res) {
            dComIfGs_onEventBit(dSv_event_flag_c::UNK_3D02);
            field_0x2CA = -1;
            dComIfGp_event_reset();
        }
    } else if (field_0x2C4 == 0) {
        normal_execute();
    } 
}

/* 00001258-0000146C       .text anim_play__10daWarpgn_cFi */
void daWarpgn_c::anim_play(int param_1) {
    if (param_1 == 0) {
        if (field_0x29C != NULL) {
            field_0x29C->setPlaySpeed(1.0f);
            field_0x29C->play();
        }
        if (field_0x2A0 != NULL) {
            field_0x2A0->setPlaySpeed(1.0f);
            field_0x2A0->play();
        }
    } else if (param_1 == 1) {
        if (field_0x29C != NULL) {
            field_0x29C->setPlaySpeed(1.0f);
            field_0x29C->play();
        }
        if (field_0x2A8 != NULL) {
            field_0x2A8->setPlaySpeed(1.0f);
            field_0x2A8->play();
        }
        if (field_0x2A4 != NULL) {
            field_0x2A4->setPlaySpeed(1.0f);
            field_0x2A4->play();
        }
    } else if (param_1 == 2) {
        if (field_0x29C != NULL) {
            field_0x29C->setPlaySpeed(1.0f);
            field_0x29C->play();
        }
        if (field_0x2A4 != NULL) {
            field_0x2A4->setFrame(field_0x2A4->getEndFrame());
        }
        if (field_0x2A8 != NULL) {
            field_0x2A8->setFrame(field_0x2A8->getEndFrame());
        }
    } else if (param_1 == 3) {
        if (field_0x29C != NULL) {
            field_0x29C->setPlaySpeed(1.0f);
            field_0x29C->play();
        }
    } else if (param_1 == 4) {
        if (field_0x29C != NULL) {
            field_0x29C->setPlaySpeed(1.0f);
            field_0x29C->play();
        }
        if (field_0x2A0 != NULL) {
            field_0x2A0->setPlaySpeed(-1.0f);
            field_0x2A0->play();
        }
    }
}

/* 0000146C-00001520       .text set_end_anim__10daWarpgn_cFv */
void daWarpgn_c::set_end_anim() {
    if (field_0x2A0 != NULL) {
        field_0x2A0->setFrame(field_0x2A0->getEndFrame());
    }

    if (field_0x2A4 != NULL) {
        field_0x2A4->setFrame(field_0x2A4->getEndFrame());
    }

    if (field_0x2A8 != NULL) {
        field_0x2A8->setFrame(field_0x2A8->getEndFrame());
    }
}

/* 00001520-000016DC       .text check_warp__10daWarpgn_cFv */
void daWarpgn_c::check_warp() {
    /* Nonmatching */
}

/* 000016DC-00001744       .text checkValidWarp__10daWarpgn_cFv */
BOOL daWarpgn_c::checkValidWarp() {
    if (!fopAcM_isSwitch(this, field_0x2B8) && 
        !dComIfGs_isEventBit(dSv_event_flag_c::UNK_3D02)) {
        return FALSE;
    }
    return TRUE;
}

/* 00001744-000018D4       .text _draw__10daWarpgn_cFv */
bool daWarpgn_c::_draw() {
    /* Nonmatching */
}

/* 000018D4-000018F4       .text daWarpgn_Create__FPv */
static cPhs_State daWarpgn_Create(void* i_this) {
    return ((daWarpgn_c*)i_this)->_create();
}

/* 000018F4-00001918       .text daWarpgn_Delete__FPv */
static BOOL daWarpgn_Delete(void* i_this) {
    return ((daWarpgn_c*)i_this)->_delete();
}

/* 00001918-0000193C       .text daWarpgn_Draw__FPv */
static BOOL daWarpgn_Draw(void* i_this) {
    return ((daWarpgn_c*)i_this)->_draw();
}

/* 0000193C-00001960       .text daWarpgn_Execute__FPv */
static BOOL daWarpgn_Execute(void* i_this) {
    return ((daWarpgn_c*)i_this)->_execute();
}

/* 00001960-00001968       .text daWarpgn_IsDelete__FPv */
static BOOL daWarpgn_IsDelete(void*) {
    return TRUE;
}

static actor_method_class daWarpgnMethodTable = {
    (process_method_func)daWarpgn_Create,
    (process_method_func)daWarpgn_Delete,
    (process_method_func)daWarpgn_Execute,
    (process_method_func)daWarpgn_IsDelete,
    (process_method_func)daWarpgn_Draw,
};

actor_process_profile_definition g_profile_WARPGANON = {
    /* LayerID      */ fpcLy_CURRENT_e,
    /* ListID       */ 0x0003,
    /* ListPrio     */ fpcPi_CURRENT_e,
    /* ProcName     */ PROC_WARPGANON,
    /* Proc SubMtd  */ &g_fpcLf_Method.base,
    /* Size         */ sizeof(daWarpgn_c),
    /* SizeOther    */ 0,
    /* Parameters   */ 0,
    /* Leaf SubMtd  */ &g_fopAc_Method.base,
    /* Priority     */ PRIO_WARPGANON,
    /* Actor SubMtd */ &daWarpgnMethodTable,
    /* Status       */ fopAcStts_CULL_e | fopAcStts_UNK4000_e | fopAcStts_UNK40000_e,
    /* Group        */ fopAc_ACTOR_e,
    /* CullType     */ fopAc_CULLBOX_CUSTOM_e,
};
